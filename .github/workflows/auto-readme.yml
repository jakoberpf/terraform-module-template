name: "auto-readme"

on:
  push:
    branches:
      - main

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Find default branch name
      id: defaultBranch
      shell: bash
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
      run: |
        default_branch=$(gh repo view --json defaultBranchRef --jq .defaultBranchRef.name)
        printf "::set-output name=defaultBranch::%s\n" "${default_branch}"
        printf "defaultBranchRef.name=%s\n" "${default_branch}"

    - name: Update Readme
      uses: terraform-docs/gh-actions@v1.0.0
      with:
        working-dir: .
        output-file: README.md
        output-method: inject

    - name: Create Pull Request
      # This action will not create or change a pull request if there are no changes to make.
      # If a PR of the auto-update/readme branch is open, this action will just update it, not create a new PR.
      uses: cloudposse/actions/github/create-pull-request@0.30.0
      with:
        token: ${{ secrets.PUBLIC_REPO_ACCESS_TOKEN }}
        commit-message: Update README.md and docs
        title: Update README.md and docs
        body: |-
          ## what
          This is an auto-generated PR that updates the README.md and docs

          ## why
          To have most recent changes of README.md and doc from origin templates

        branch: auto-update/readme
        base: ${{ steps.defaultBranch.outputs.defaultBranch }}
        delete-branch: true
        labels: |
          auto-update
          no-release
          readme
